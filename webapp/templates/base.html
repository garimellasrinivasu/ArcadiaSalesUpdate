<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Arcadia Sales{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  {% if session.get('user_id') %}
  <aside class="sidebar">
    <div class="brand">Arcadia Sales</div>
    <nav class="menu">
      {% if session.get('role') == 'CRM' %}
        <a href="{{ url_for('crm_new') }}">New Entry</a>
        <a href="{{ url_for('crm_list') }}">My Entries</a>
        <a href="{{ url_for('crm_sales_people') }}">Sales People</a>
      {% elif session.get('role') == 'ADMIN' %}
        <a href="{{ url_for('admin_dashboard') }}">Dashboard</a>
        <a href="{{ url_for('admin_entries') }}">My Entries</a>
        <a href="{{ url_for('admin_crms') }}">Manage CRMs</a>
        <a href="{{ url_for('admin_options') }}">Options</a>
        <a href="{{ url_for('admin_new') }}">New Sale</a>
      {% endif %}
      <a href="{{ url_for('logout') }}">Logout</a>
    </nav>
  </aside>
  {% endif %}
  <main class="container {% if session.get('user_id') %}with-sidebar{% endif %}">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-area">
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>
  <script src="{{ url_for('static', filename='app.js') }}"></script>
  <script>
    (function(){
      function initSavedModal(){
        const params = new URLSearchParams(window.location.search);
        function cleanUrl(){
          params.delete('saved');
          params.delete('s_no');
          const url = window.location.pathname + (params.toString()?('?'+params.toString()):'');
          window.history.replaceState({}, document.title, url);
        }
        function showSaleCreatedModal(){
          const modal = document.getElementById('sale-created-modal');
          if(!modal) return;
          const msg = modal.querySelector('.modal-message');
          const sno = params.get('s_no');
          msg.textContent = sno ? `Sale created successfully. S.No: ${sno}` : 'Sale created successfully.';
          modal.classList.add('open');
          const ok = modal.querySelector('.modal-ok');
          ok.addEventListener('click', ()=>{ modal.classList.remove('open'); cleanUrl(); }, { once:true });
        }
        const isNewPage = ['/admin/new','/crm/new'].includes(window.location.pathname);
        if(params.get('saved')==='1' && (document.getElementById('allow-saved-modal') || isNewPage)){
          showSaleCreatedModal();
        }
      }
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', initSavedModal);
      } else {
        initSavedModal();
      }
    })();
  </script>
  {% block scripts %}{% endblock %}
  <div id="sale-created-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">Success</div>
      <div class="modal-body"><p class="modal-message">Sale created successfully.</p></div>
      <div class="modal-actions"><button class="btn modal-ok" type="button">OK</button></div>
    </div>
  </div>
  <div class="print-footer"></div>
</body>
</html>
